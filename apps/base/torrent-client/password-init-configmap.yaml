apiVersion: v1
kind: ConfigMap
metadata:
  name: qbittorrent-password-init
  namespace: downloaders
data:
  set-password.sh: |
    #!/bin/sh
    set -e
    
    CONFIG_FILE="/config/qBittorrent/qBittorrent.conf"
    
    echo "Checking qBittorrent config..."
    
    # Create config directory if it doesn't exist
    mkdir -p /config/qBittorrent
    
    # Check if password is already set in config
    if grep -q "WebUI\\\\\\\\Password_PBKDF2" "$CONFIG_FILE" 2>/dev/null; then
      echo "WebUI password already configured, skipping..."
      exit 0
    fi
    
    echo "Setting WebUI password in config..."
    
    # If config file doesn't exist, create minimal config
    if [ ! -f "$CONFIG_FILE" ]; then
      cat > "$CONFIG_FILE" << 'ENDCONFIG'
    [Preferences]
    WebUI\Address=*
    WebUI\ServerDomains=*
    WebUI\Username=admin
    ENDCONFIG
    fi
    
    # Add or update the password hash in the Preferences section
    if grep -q "\[Preferences\]" "$CONFIG_FILE"; then
      # Add password after [Preferences] section if not exists
      if ! grep -q "WebUI\\\\\\\\Password_PBKDF2" "$CONFIG_FILE"; then
        sed -i '/\[Preferences\]/a WebUI\\Password_PBKDF2="@ByteArray(n6/U9Y0dglkv4UG3D4MhshPc7wAu1kVNeto/8hFO7rdbazJgP2WTC8ZNx/ctjliOYaQ4WBKOUOG2/kTDgvNQpA==)"' "$CONFIG_FILE"
        echo "Password hash added to config"
      fi
    else
      # No Preferences section, append it
      cat >> "$CONFIG_FILE" << 'ENDCONFIG'

    [Preferences]
    WebUI\Address=*
    WebUI\ServerDomains=*
    WebUI\Username=admin
    WebUI\Password_PBKDF2="@ByteArray(n6/U9Y0dglkv4UG3D4MhshPc7wAu1kVNeto/8hFO7rdbazJgP2WTC8ZNx/ctjliOYaQ4WBKOUOG2/kTDgvNQpA==)"
    ENDCONFIG
      echo "Preferences section created with password"
    fi
    
    echo "Password configuration complete!"
